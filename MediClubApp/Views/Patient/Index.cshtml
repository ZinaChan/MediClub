@model IEnumerable<Patient>;
@{
    Layout = "~/Views/Shared/_LayoutAuth.cshtml";
    ViewData["Title"] = "Patient Page";
    var IsAdmin = base.User.IsInRole("Admin");
}

@functions {
    public string GetDefaultAvatarUrl(string? gender)
    {
        if (gender == nameof(Gender.Male))
        {
            return "images/anonymous-man.png";
        }
        else if (gender == nameof(Gender.Female))
        {
            return "images/anonymous-woman.png";
        }
        else
        {
            return "images/anonymous.png";
        }
    }
}

<h1>Patients List</h1>
<hr />

<div class="col mb-3">
    <div class="row-col-auto">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="Search by name or email" id="searchString">
            <button type="button" class="btn btn-outline-primary" onclick="searchPatients()">Search</button>
        </div>
    </div>
</div>

@if (!Model.Any() || Model is null)
{
    <div class="container mt-4">
        <div class="text-center">
            <img src="/images/sad-star.png" alt="No Patients" class="img-fluid" style="width: 100px; height: 100px;">
            <p>No patients available at the moment.</p>
        </div>
    </div>
}
else
{
    <div class="container">
        <div class="row row-cols-1 row-cols-md-2 g-4" id="patientList">
            @foreach (var patient in Model)
            {
                <div class="col patient-card"> 
                    <div class="card mb-3 w-100 h-100">
                        <div class="row g-0 h-100">
                            <div class="col-md-4">
                                <img src="/@(patient.AvatarUrl ?? GetDefaultAvatarUrl(patient?.Gender))"
                                    class="img-fluid rounded-start w-100 h-100 object-fit-cover" alt="Patient Avatar">
                            </div>
                            <div class="col-md-8">
                                <div class="card-body">
                                    <h5>@(patient?.FirstName ?? "UNKNOWN") @(patient?.LastName ?? "UNKNOWN")</h5>
                                    <p class="card-text"><strong>Email:</strong> @(patient?.Email ?? "UNKNOWN")</p>
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <a class="btn btn-primary" asp-controller="Patient" asp-action="PatientInfo"
                                                asp-route-patientId="@patient?.Id">View</a>
                                            @if (IsAdmin)
                                            {
                                                <button class="btn btn-danger"
                                                    onclick="deletePatient('@patient?.Id')">Delete</button>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            } 
        </div>
    </div>
}

<script>
    function searchPatients() {
        const searchString = document.getElementById('searchString').value.trim().toLowerCase();
        const patientCards = document.querySelectorAll('.patient-card');

        patientCards.forEach(card => {
            const userName = card.querySelector('h5').textContent.trim().toLowerCase();
            const userEmail = card.querySelector('.card-text:nth-of-type(1)').textContent.trim().toLowerCase();

            if (userName.includes(searchString) || userEmail.includes(searchString)) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }

    document.getElementById('searchString').addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
            searchPatients();
        }
    });
</script>
 
    <script>
        function deletePatient(id) {
            if (confirm('Are you sure you want to delete this patient?')) {
                fetch(`/Patient/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            alert('Patient deleted successfully!');
                            window.location.reload();
                        } else {
                            alert('Failed to delete patient.');
                        }
                    })
                    .catch(error => console.error('Error deleting patient:', error));
            }
        }
    </script> 

@section Scripts {
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
}
